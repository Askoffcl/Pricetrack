<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Enter Card Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .card-form {
      max-width: 500px;
      margin: 50px auto;
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <div class="card-form">
    <h3 class="mb-4 text-center">Enter Card Details</h3>
    <form method="post" novalidate>
      {% csrf_token %}

      <div class="mb-3">
        <label for="cardNumber" class="form-label">Card Number</label>
        <input type="text" id="cardNumber" name="number" class="form-control" 
               pattern="\d{16}" maxlength="16" placeholder="1234567890123456" required>
        <div class="invalid-feedback">Please enter a valid 16-digit card number.</div>
      </div>

      <div class="mb-3">
        <label for="cardName" class="form-label">Name on Card</label>
        <input type="text" id="cardName" name="name" class="form-control" required>
        <div class="invalid-feedback">Card name is required.</div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="expiry" class="form-label">Expiry Date (MM/YY)</label>
          <input type="text" id="expiry" name="expiry" class="form-control"
                 pattern="^(0[1-9]|1[0-2])\/\d{2}$" placeholder="MM/YY" required>
          <div class="invalid-feedback" id="expiryFeedback">Enter expiry in MM/YY format and not in the past.</div>
        </div>
        <div class="col-md-6 mb-3">
          <label for="cvv" class="form-label">CVV</label>
          <input type="text" id="cvv" name="cvv" class="form-control"
                 pattern="\d{3}" maxlength="3" required>
          <div class="invalid-feedback">CVV must be 3 digits.</div>
        </div>
      </div>

      <div class="d-grid">
        <button type="submit" class="btn btn-primary">Submit Payment</button>
      </div>
    </form>
  </div>

  <script>
    (() => {
      'use strict';

      const form = document.querySelector('form');
      const expiryInput = document.getElementById('expiry');
      const expiryFeedback = document.getElementById('expiryFeedback');

      form.addEventListener('submit', event => {
        let isValid = true;

        // Check overall form validity
        if (!form.checkValidity()) {
          isValid = false;
        }

        // Check expiry not in the past
        const expiryValue = expiryInput.value.trim();
        const match = expiryValue.match(/^(0[1-9]|1[0-2])\/(\d{2})$/);

        if (match) {
          const inputMonth = parseInt(match[1], 10);
          const inputYear = parseInt('20' + match[2], 10);

          const today = new Date();
          const currentMonth = today.getMonth() + 1;
          const currentYear = today.getFullYear();

          if (inputYear < currentYear || (inputYear === currentYear && inputMonth < currentMonth)) {
            isValid = false;
            expiryInput.classList.add('is-invalid');
            expiryFeedback.textContent = "Card has expired.";
          } else {
            expiryInput.classList.remove('is-invalid');
          }
        } else {
          isValid = false;
          expiryInput.classList.add('is-invalid');
          expiryFeedback.textContent = "Invalid expiry format.";
        }

        if (!isValid) {
          event.preventDefault();
          event.stopPropagation();
        }

        form.classList.add('was-validated');
      }, false);
    })();
  </script>

</body>
</html>
